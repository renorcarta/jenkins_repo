pipeline {
    agent any

    parameters {
        string(name: 'ApplicationScope', defaultValue: 'https://cmiti-dev.outsystemsenterprise.com/', description: 'Comma-separated list of LifeTime applications to deploy.')
        string(name: 'ApplicationScopeWithTests', defaultValue: 'LOMSWEB', description: 'Comma-separated list of LifeTime applications (including tests).')
        string(name: 'TriggeredBy', defaultValue: 'Reynor Carta', description: 'Name of LifeTime user that triggered the pipeline remotely.')
    }

    options {
        skipStagesAfterUnstable()
    }

    environment {
        ArtifactsFolder = "Artifacts"
        LifeTimeHostname = 'https://cmiti-lt.outsystemsenterprise.com'
        ArchitectureDashboard = 'https://aimentorstudio.outsystems.com'
        LifeTimeAPIVersion = '2'
        AuthorizationToken = credentials('LifeTimeServiceAccountToken')
        OSPackageVersion = '0.10.1'
    }

    stages {
        stage('Prepare Environment') {
            steps {
                sh "mkdir -p ${env.ArtifactsFolder}"
                sh '''
                    set -e
                    python3 -m venv venv
                    . venv/bin/activate
                    pip install --upgrade pip
                    pip install requests beautifulsoup4
                    pip install outsystems-pipeline==${OSPackageVersion} requests
                '''
            }
        }

        stage('Fetch LifeTime Data') {
            steps {
                withCredentials([string(credentialsId: 'LifeTimeServiceAccountToken', variable: 'LT_TOKEN')]) {
                    sh '''
                        . venv/bin/activate
                        python3 -m outsystems.pipeline.fetch_lifetime_data \
                            --artifacts "${ArtifactsFolder}" \
                            --lt_url "${LifeTimeHostname}" \
                            --lt_token "${LT_TOKEN}" \
                            --lt_api_version "${LifeTimeAPIVersion}"
                    '''
                    sh "ls -l ${env.ArtifactsFolder}"
                }
            }
        }

        stage('Check Architectural Debt') {
            steps {
                withCredentials([string(credentialsId: 'LifeTimeServiceAccountToken', variable: 'LT_TOKEN')]) {
                    script {
                        sh '''
                            # Activate virtual environment if needed
                            . venv/bin/activate

                            # Run the architectural debt analysis script
                            python3 outsystems/pipeline/get_architectural_debt.py \
                                --app_name "${ApplicationScopeWithTests}" \
                                --artifacts "${ArtifactsFolder}" \
                                --lifetime_host "${LifeTimeHostname}" \
                                --arch_dashboard_host "${ArchitectureDashboard}" \
                                --token "${LT_TOKEN}" \
                                --output "${ArtifactsFolder}/arch-debt.json"

                            # Now run the quality gate checker
                            python3 check_architecture_quality.py
                        '''
                    }
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: "${ArtifactsFolder}/arch-debt.json", allowEmptyArchive: true
                }
                success {
                    echo "✅ Architectural debt check passed."
                }
                failure {
                    echo "❌ Architectural debt check failed. Review 'arch-debt.json' for details."
                }
            }
        }
    }

    post {
        always {
            dir("${env.ArtifactsFolder}") {
                sh 'echo "Listing Artifacts folder contents:" && ls -la || true'
                archiveArtifacts artifacts: '**/*', allowEmptyArchive: true
            }
        }
        cleanup {
            dir("${env.ArtifactsFolder}") {
                deleteDir()
            }
        }
    }
}
